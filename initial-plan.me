# Webアプリケーション設計指示書: マルチモーダル画像生成ツール

## 1. プロジェクト概要

Google GenAI SDK (`gemini-3-pro-image-preview`) を活用し、キャラクターやレイアウトのリファレンス画像を元に、4つのシーン（コマ）を指定して画像を生成するローカルWebアプリケーション。軽量・高速な動作を重視し、誰でもGitHubからクローンしてすぐにローカル環境 (`localhost`) で利用できることを目的とする。

## 2. 技術スタック

* **バックエンド:** Python, FastAPI (APIサーバー及び静的ファイルの配信)
* **AI SDK:** `google-genai`
* **フロントエンド:** HTML, Vanilla JavaScript, ネイティブCSS (外部フレームワーク不使用。軽さと速さを最優先)

## 3. ディレクトリ構成（想定）

```text
project_root/
├── main.py                # FastAPIのサーバーコード（APIエンドポイント）
├── requirements.txt       # 依存パッケージ (fastapi, uvicorn, python-multipart, google-genai)
├── static/
│   ├── index.html         # フロントエンドUI
│   ├── app.js             # クライアント側の処理 (Vanilla JS)
│   ├── style.css          # シンプルなスタイリング
│   ├── layout_refs/       # レイアウトリファレンス画像の保存・参照用フォルダ
│   ├── char_refs/         # キャラクターリファレンス画像の保存・参照用フォルダ
│   └── outputs/           # 生成された画像の一時保存用フォルダ

```

## 4. 機能要件

### 4.1. 画像設定機能

* **アスペクト比指定:** ドロップダウン等で出力画像のアスペクト比を指定できる（例: `1:1`, `3:4`, `16:9` など。APIの `ImageConfig` に渡す）。

### 4.2. リファレンス画像管理機能

アップロード機能だけでなく、ローカルフォルダ内の既存画像をリストから選択（参照）できる仕組みを実装する。

* **レイアウトリファレンス:** `static/layout_refs/` フォルダ内の画像を選択、または新規アップロード（アップロード時は同フォルダに保存）できる。1枚指定。
* **キャラクターリファレンス:**
* `static/char_refs/` フォルダ内の画像を選択、または新規アップロード（同フォルダに保存）できる。
* 各キャラクターに「名前」を入力するテキストフィールドを持つ。
* 「キャラクターを追加」ボタンで、この入力セット（画像選択/UP ＋ 名前）を動的に複数追加できる。

### 4.3. プロンプト入力機能（4コマ構成）

全体プロンプトではなく、**4つのコマ（シーン）ごと**に以下の3つの入力欄を用意する。

1. **シーン:** そのコマの状況やアクション（テキスト）。
2. **キャラクターの様子:** 登録されたキャラクターの数だけ動的に入力欄が生成される。（例: 「キャラAは驚いている」「キャラBは笑っている」）。
3. **オブジェクト (背景・副題):** そのコマの背景や小物などの指定（テキスト）。

### 4.4. 画像生成と結果表示機能

* **「画像生成」ボタン:** 入力された全データ（リファレンス画像、各コマのプロンプト、設定）をJSON/MultipartでFastAPIに送信する。
* **思考過程の表示:** APIからストリーミング（または一括）で返ってくるテキストデータ（思考過程）を表示する領域。デフォルトは「折り畳み状態（アコーディオンUI）」とし、クリックで開閉できる。
* **出力画像の表示とDL:** 生成された画像 (`outputs/` に保存されたもの) を画面に表示し、「ダウンロード」ボタンでユーザーの端末に保存させる。

### 4.5. やり直し（リトライ）機能

生成結果に対し、以下の2つのボタンを提供する。

* **「思考過程からやり直す」ボタン:** 現在のUIの入力状態を保持したまま、最初からAPIリクエストを再実行する。
* **「画像生成部分だけやり直す」ボタン:** 前回出力された「思考過程（テキスト）」をプロンプトとしてシステム側に組み込み、画像生成のみを再度実行させる（FastAPI側でプロンプトを再構築する）。

## 5. バックエンド (FastAPI) 実装要件

* **静的ファイル配信:** `/static` へのルーティングを行い、HTML/JS/CSS および画像フォルダにアクセスできるようにする。
* **ファイル一覧取得API:** `layout_refs/` と `char_refs/` 内のファイル名一覧をフロントエンドに返すエンドポイントを作成する。
* **画像生成API:** フロントエンドからのリクエストを受け取り、`google-genai` SDK を使用して `gemini-3-pro-image-preview` モデルを呼び出す。
* フロントエンドから送られた4コマ分の情報を、Geminiが理解しやすい構造化されたテキスト（マークダウン等）に結合して `user` ロールの `types.Part` として渡す。
* 選択されたリファレンス画像はバイナリとして読み込み、適切な `mime_type` と共に `types.Part` に含める。
* レスポンス内のテキスト部分は「思考過程」として、画像データ (`inline_data`) は `outputs/` に連番やUUIDで保存した上で、フロントエンドにURLを返す。

## 6. UI/UX (フロントエンド) 実装要件

* **デザイン:** プレーンなHTML5と最小限のCSSで構築。白やグレーを基調としたシンプルで直感的なレイアウト。
* **動作:** ページ遷移を行わないSPA (Single Page Application) 風の挙動を Vanilla JS (Fetch API) で実装する。ローディング中はスピナーや「生成中...」のテキストを表示し、ユーザーを待たせていることを明示する。